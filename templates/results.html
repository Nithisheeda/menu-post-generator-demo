{% extends "base.html" %}

{% block title %}Generated Posts - Social Media Post Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-share-alt me-2"></i>Generated Social Media Posts</h2>
            <div class="btn-group">
                <a href="{{ url_for('export_posts', format='json') }}" class="btn btn-success">
                    <i class="fas fa-download me-1"></i>Export JSON
                </a>
                <a href="{{ url_for('export_posts', format='csv') }}" class="btn btn-success">
                    <i class="fas fa-file-csv me-1"></i>Export CSV
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>Generate More Posts
                </a>
            </div>
        </div>
        
        <div class="alert alert-info mb-4">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Success!</strong> Generated {{ posts|length }} Instagram-style posts from your menu. 
            Copy and paste the content below to your social media platforms.
        </div>
    </div>
</div>

<div class="row">
    {% for post in posts %}
    <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card post-card h-100 shadow-sm" id="post-card-{{ loop.index0 }}">
            <div class="card-header bg-gradient-instagram text-white">
                <div class="d-flex align-items-center">
                    <div class="instagram-avatar me-2">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">Your Restaurant</h6>
                        <small class="opacity-75">
                            Instagram Post #{{ loop.index }}
                            {% if post.variant %}
                            <span class="badge bg-light text-dark ms-2">{{ post.variant|title }}</span>
                            {% endif %}
                        </small>
                    </div>
                    {% if ab_test_mode %}
                    <div class="ab-test-indicator">
                        <small class="text-white opacity-75">A/B Test</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if post.image_url %}
            <div class="card-img-container">
                <img src="{{ post.image_url }}" class="card-img-top post-image" alt="Generated food image" loading="lazy" id="post-image-{{ loop.index0 }}">
                <div class="image-overlay">
                    <button class="btn btn-sm btn-light replace-image-btn" onclick="document.getElementById('file-upload-{{ loop.index0 }}').click()">
                        <i class="fas fa-camera me-1"></i>Replace
                    </button>
                </div>
            </div>
            {% endif %}
            
            <div class="upload-section d-none">
                <input type="file" id="file-upload-{{ loop.index0 }}" accept="image/*" onchange="uploadImage({{ loop.index0 }}, this)" class="d-none">
            </div>
            
            <div class="card-body">
                <div class="post-content mb-3">
                    <p class="post-caption">{{ post.caption }}</p>
                    {% if post.caption_german and language == 'both' %}
                    <div class="mt-2 pt-2 border-top">
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-language me-1"></i>German Translation:
                        </small>
                        <p class="post-caption-german">{{ post.caption_german }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="hashtags-section">
                    <div class="hashtags">
                        {% for hashtag in post.hashtags %}
                        <span class="badge bg-primary me-1 mb-1">#{{ hashtag }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                {% if post.image_prompt %}
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-palette me-1"></i>Image prompt: {{ post.image_prompt }}
                    </small>
                </div>
                {% endif %}
            </div>
            
            <div class="card-footer bg-light">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="copyPost({{ loop.index0 }}, event)" data-post-id="{{ post.post_id }}">
                        <i class="fas fa-copy me-1"></i>Copy Post
                    </button>
                    {% if not post.image_url %}
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('file-upload-{{ loop.index0 }}').click()">
                        <i class="fas fa-upload me-1"></i>Add Image
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard me-2"></i>Original Menu Input</h5>
            </div>
            <div class="card-body">
                <div class="menu-preview">
                    {{ menu_text | e | replace('\n', '<br>') | safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store posts data for copying
const postsData = {{ posts|tojson|safe }};
const abTestMode = {{ ab_test_mode|tojson|safe }};

// A/B Test click tracking
function trackClick(postId, action) {
    if (abTestMode) {
        console.log(`A/B Test Click: Post ${postId}, Action: ${action}, Timestamp: ${new Date().toISOString()}`);
        // In production, you would send this to your analytics service
    }
}

// Image upload functionality
function uploadImage(postIndex, fileInput) {
    const file = fileInput.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('image', file);
    
    fetch(`/upload_image/${postIndex}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update image preview
            const imgElement = document.getElementById(`post-image-${postIndex}`);
            if (imgElement) {
                imgElement.src = data.url;
            } else {
                // If no image was there before, create one
                const cardBody = document.querySelector(`#post-card-${postIndex} .card-body`);
                if (cardBody) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'card-img-container';
                    imgContainer.innerHTML = `
                        <img src="${data.url}" class="card-img-top post-image" alt="Uploaded image" id="post-image-${postIndex}">
                        <div class="image-overlay">
                            <button class="btn btn-sm btn-light replace-image-btn" onclick="document.getElementById('file-upload-${postIndex}').click()">
                                <i class="fas fa-camera me-1"></i>Replace
                            </button>
                        </div>
                    `;
                    cardBody.parentElement.insertBefore(imgContainer, cardBody);
                    
                    // Remove the "Add Image" button since we now have an image
                    const addImageBtn = document.querySelector(`#post-card-${postIndex} .card-footer button[onclick*="file-upload-${postIndex}"]`);
                    if (addImageBtn) {
                        addImageBtn.remove();
                    }
                }
            }
            
            // Track upload event
            trackClick(postsData[postIndex].post_id, 'image_upload');
        } else {
            alert('Error uploading image: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Error uploading image');
    });
}

function copyPost(index, event) {
    const post = postsData[index];
    let fullPost = post.caption;
    
    // Add German translation if available
    if (post.caption_german) {
        fullPost += '\n\nðŸ‡©ðŸ‡ª ' + post.caption_german;
    }
    
    fullPost += '\n\n' + post.hashtags.map(tag => '#' + tag).join(' ');
    
    // Track copy action
    trackClick(post.post_id, 'copy_post');
    
    navigator.clipboard.writeText(fullPost).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = fullPost;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}
</script>
{% endblock %}